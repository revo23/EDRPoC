#!/usr/bin/env python3
"""EDR PoC - Malware Behavior Simulator

Simulates various malicious behaviors to test EDR detection capabilities.
All simulations are SAFE - no actual damage is performed. They create
artifacts and patterns that trigger the EDR's behavioral and ML detections.

Usage:
    python3 tests/simulate_malware.py          # Interactive menu
    python3 tests/simulate_malware.py --all    # Run all simulations
    python3 tests/simulate_malware.py --test N # Run specific test (1-7)
"""

import math
import os
import random
import socket
import string
import struct
import subprocess
import sys
import tempfile
import time


BANNER = """
================================================================
  EDR PoC - Malware Behavior Simulator
  For testing/educational purposes only
================================================================
"""

SIMULATIONS = [
    ("Discovery Commands", "Runs reconnaissance commands (whoami, id, uname, etc.)"),
    ("Persistence (LaunchAgent)", "Creates a LaunchAgent plist file"),
    ("Encoded Execution", "Runs base64-encoded commands"),
    ("Reverse Shell Pattern", "Creates processes matching reverse shell signatures"),
    ("Data Exfiltration Pattern", "Writes large temp files simulating staging"),
    ("Ransomware Simulation", "Mass file creation with high-entropy + renames"),
    ("Crypto Miner Pattern", "CPU-intensive loop with miner-like characteristics"),
]


def simulate_discovery():
    """Simulate system discovery/reconnaissance commands."""
    print("[*] Simulating discovery command sequence...")
    commands = ["whoami", "id", "uname -a", "hostname", "sw_vers", "ifconfig"]
    for cmd in commands:
        print(f"    Running: {cmd}")
        try:
            result = subprocess.run(
                cmd.split(), capture_output=True, text=True, timeout=5
            )
            print(f"    -> {result.stdout.strip()[:80]}")
        except (subprocess.TimeoutExpired, FileNotFoundError, OSError):
            print(f"    -> (command not available)")
        time.sleep(0.5)
    print("[+] Discovery simulation complete - should trigger IOA-006 (T1082)\n")


def simulate_persistence():
    """Simulate LaunchAgent persistence mechanism."""
    print("[*] Simulating persistence via LaunchAgent...")
    launch_agents_dir = os.path.expanduser("~/Library/LaunchAgents")
    os.makedirs(launch_agents_dir, exist_ok=True)

    plist_name = "com.edr.test.simulate.plist"
    plist_path = os.path.join(launch_agents_dir, plist_name)

    plist_content = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.edr.test.simulate</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/true</string>
    </array>
    <key>RunAtLoad</key>
    <false/>
    <key>Disabled</key>
    <true/>
</dict>
</plist>
"""
    with open(plist_path, "w") as f:
        f.write(plist_content)

    print(f"    Created: {plist_path}")
    time.sleep(2)

    # Clean up
    os.remove(plist_path)
    print(f"    Cleaned up: {plist_path}")
    print("[+] Persistence simulation complete - should trigger IOA-004 (T1543.001)\n")


def simulate_encoded_execution():
    """Simulate base64-encoded command execution."""
    print("[*] Simulating encoded command execution...")

    # Encode a harmless command and decode it in Python (no shell needed)
    import base64
    harmless_cmd = "echo EDR_TEST_ENCODED_EXECUTION"
    encoded = base64.b64encode(harmless_cmd.encode()).decode()
    decoded = base64.b64decode(encoded).decode()

    print(f"    Encoded: {encoded}")
    print(f"    Decoded: {decoded}")

    # Execute the decoded command using safe list form (no shell interpretation)
    try:
        result = subprocess.run(
            decoded.split(), capture_output=True, text=True, timeout=5
        )
        print(f"    -> {result.stdout.strip()}")
    except (subprocess.TimeoutExpired, FileNotFoundError, OSError):
        pass

    time.sleep(1)
    print("[+] Encoded execution simulation complete - should trigger IOA-008 (T1140)\n")


def simulate_reverse_shell():
    """Simulate reverse shell-like process patterns (SAFE - no actual connection)."""
    print("[*] Simulating reverse shell pattern...")

    # Create a script that looks like a reverse shell but does nothing harmful
    script = """#!/bin/bash
# EDR TEST - simulated reverse shell pattern (harmless)
# This just creates process tree patterns that match reverse shell signatures
echo "EDR_TEST: Simulated reverse shell pattern"
sleep 1
"""
    with tempfile.NamedTemporaryFile(mode="w", suffix=".sh", delete=False) as f:
        f.write(script)
        script_path = f.name

    os.chmod(script_path, 0o755)

    # Execute it via bash to create the process tree pattern
    print("    Creating bash subprocess with network-like pattern...")
    try:
        proc = subprocess.Popen(
            ["bash", script_path],
            stdout=subprocess.PIPE, stderr=subprocess.PIPE
        )
        proc.wait(timeout=5)
    except subprocess.TimeoutExpired:
        proc.kill()
    finally:
        os.unlink(script_path)

    # Create a socket to simulate network activity (connects to localhost only)
    print("    Creating local socket connection...")
    try:
        server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server.bind(("127.0.0.1", 0))
        port = server.getsockname()[1]
        server.listen(1)

        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client.connect(("127.0.0.1", port))
        conn, _ = server.accept()

        time.sleep(1)

        conn.close()
        client.close()
        server.close()
    except OSError:
        pass

    print("[+] Reverse shell simulation complete - should trigger IOA-002/IOA-013\n")


def simulate_data_exfil():
    """Simulate data exfiltration staging pattern."""
    print("[*] Simulating data exfiltration staging...")

    staging_dir = tempfile.mkdtemp(prefix="edr_exfil_test_", dir="/tmp")
    print(f"    Staging directory: {staging_dir}")

    # Create multiple files with "collected" data
    for i in range(10):
        filepath = os.path.join(staging_dir, f"collected_data_{i}.dat")
        data = os.urandom(1024 * 100)  # 100KB of random data per file
        with open(filepath, "wb") as f:
            f.write(data)
        print(f"    Created: {filepath} ({len(data)} bytes)")
        time.sleep(0.3)

    # Create an archive-like file (high entropy)
    archive_path = os.path.join(staging_dir, "exfil_archive.tar.gz")
    with open(archive_path, "wb") as f:
        f.write(os.urandom(1024 * 500))  # 500KB
    print(f"    Created archive: {archive_path}")

    time.sleep(2)

    # Clean up
    import shutil
    shutil.rmtree(staging_dir)
    print(f"    Cleaned up staging directory")
    print("[+] Exfiltration simulation complete - should trigger IOA-014 (T1027)\n")


def simulate_ransomware():
    """Simulate ransomware behavior: mass file creation + high entropy + renames."""
    print("[*] Simulating ransomware behavior...")

    ransom_dir = tempfile.mkdtemp(prefix="edr_ransom_test_", dir="/tmp")
    print(f"    Target directory: {ransom_dir}")

    # Create "victim" files
    filenames = []
    for i in range(30):
        filepath = os.path.join(ransom_dir, f"document_{i}.txt")
        content = f"This is test document {i} for EDR ransomware simulation.\n" * 50
        with open(filepath, "w") as f:
            f.write(content)
        filenames.append(filepath)

    print(f"    Created {len(filenames)} victim files")
    time.sleep(1)

    # "Encrypt" files (write high-entropy data and rename)
    encrypted_count = 0
    for filepath in filenames:
        # Write random (high entropy) content to simulate encryption
        with open(filepath, "wb") as f:
            f.write(os.urandom(2048))

        # Rename with ransomware-like extension
        encrypted_path = filepath + ".encrypted"
        os.rename(filepath, encrypted_path)
        encrypted_count += 1

        if encrypted_count % 10 == 0:
            print(f"    Encrypted {encrypted_count}/{len(filenames)} files...")
        time.sleep(0.1)

    # Create "ransom note"
    note_path = os.path.join(ransom_dir, "README_DECRYPT.txt")
    with open(note_path, "w") as f:
        f.write("THIS IS A TEST - EDR RANSOMWARE SIMULATION\n")
        f.write("No actual files were harmed.\n")

    print(f"    Created ransom note: {note_path}")
    time.sleep(2)

    # Clean up
    import shutil
    shutil.rmtree(ransom_dir)
    print(f"    Cleaned up ransomware test directory")
    print("[+] Ransomware simulation complete - should trigger IOA-012/IOA-014/IOA-016\n")


def simulate_crypto_miner():
    """Simulate cryptocurrency miner behavior: high CPU usage."""
    print("[*] Simulating crypto miner behavior (5 seconds of high CPU)...")

    # CPU-intensive work to simulate mining
    start = time.time()
    duration = 5
    iterations = 0

    print("    Running CPU-intensive computation...")
    while time.time() - start < duration:
        # Perform meaningless but CPU-intensive math
        x = random.random()
        for _ in range(10000):
            x = math.sin(x) * math.cos(x) + math.sqrt(abs(x) + 1)
        iterations += 1

    elapsed = time.time() - start
    print(f"    Completed {iterations} iterations in {elapsed:.1f}s")
    print("[+] Crypto miner simulation complete - should trigger IOA-011 (T1496)\n")


def run_simulation(index):
    """Run a specific simulation by index (0-based)."""
    sims = [
        simulate_discovery,
        simulate_persistence,
        simulate_encoded_execution,
        simulate_reverse_shell,
        simulate_data_exfil,
        simulate_ransomware,
        simulate_crypto_miner,
    ]
    if 0 <= index < len(sims):
        print(f"\n{'=' * 60}")
        print(f"  Running: {SIMULATIONS[index][0]}")
        print(f"{'=' * 60}\n")
        sims[index]()
        return True
    return False


def run_all():
    """Run all simulations in sequence."""
    print("\n[*] Running ALL simulations...\n")
    for i in range(len(SIMULATIONS)):
        run_simulation(i)
        time.sleep(2)
    print("=" * 60)
    print("  All simulations complete!")
    print("  Check the EDR dashboard at http://localhost:5000")
    print("=" * 60)


def interactive_menu():
    """Show interactive menu for selecting simulations."""
    while True:
        print("\nAvailable Simulations:")
        print("-" * 50)
        for i, (name, desc) in enumerate(SIMULATIONS, 1):
            print(f"  {i}. {name}")
            print(f"     {desc}")
        print(f"  8. Run ALL simulations")
        print(f"  0. Exit")
        print("-" * 50)

        try:
            choice = input("\nSelect simulation [0-8]: ").strip()
        except (EOFError, KeyboardInterrupt):
            print("\nExiting.")
            break

        if choice == "0":
            break
        elif choice == "8":
            run_all()
        elif choice.isdigit() and 1 <= int(choice) <= len(SIMULATIONS):
            run_simulation(int(choice) - 1)
        else:
            print("Invalid choice.")


def main():
    print(BANNER)

    if "--all" in sys.argv:
        run_all()
    elif "--test" in sys.argv:
        try:
            idx = int(sys.argv[sys.argv.index("--test") + 1])
            if not run_simulation(idx - 1):
                print(f"Invalid test number. Choose 1-{len(SIMULATIONS)}")
        except (IndexError, ValueError):
            print("Usage: --test N (where N is 1-7)")
    else:
        interactive_menu()


if __name__ == "__main__":
    main()
